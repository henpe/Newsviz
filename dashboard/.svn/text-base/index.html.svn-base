<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
	<head>
		<title>Dashboard</title>
		<script src="/scripts/jquery-1.3.2.min.js" type="text/javascript"></script>
		<script src="/scripts/jquery.timeago.js" type="text/javascript"></script>
		<script src="/scripts/jquery-ui-1.7.2.custom/js/jquery-ui-1.7.2.custom.min.js" type="text/javascript"></script>
		
		<link rel="stylesheet" href="/styles/main.css" type="text/css" />
		<link rel="stylesheet" href="/styles/theme_white.css" type="text/css" />
		<link type="text/css" href="/scripts/jquery-ui-1.7.2.custom/css/ui-lightness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />

	</head>
	<body id="dashboard">
		<div id="container">
			<div id="map"></div>
			<div id="pages">
				<div id="status"></div>
				<span id="refresh">Refresh</span>
				<div id="progressbar"></div>
				<ol></ol>
			</div>
			<div id="people">
				<h2><span>People in the news</span></h2>
				<ol></ol>
			</div>
			<div id="stats">
				<ul>
					<li class="lang-pt-BR"><a href="http:///www.bbc.co.uk/portuguese/">BBC Brasil</a><span></span></li>
					<li class="lang-es"><a href="http:///www.bbc.co.uk/mundo/">BBC Mundo</a><span></span></li>
					<li class="lang-ar"><a href="http:///www.bbc.co.uk/arabic/">BBC Arabic</a><span></span></li>
					<li class="lang-fa"><a href="http:///www.bbc.co.uk/persian/">BBC Persian</a><span></span></li>
					<li class="lang-ru"><a href="http:///www.bbc.co.uk/russian/">BBC Russian</a><span></span></li>
					<li class="lang-vi"><a href="http:///www.bbc.co.uk/vietnamese/">BBC Vietnamese</a><span></span></li>
					<li class="lang-tr"><a href="http:///www.bbc.co.uk/turkish/">BBC Turkish</a><span></span></li>
					<li class="lang-hi"><a href="http:///www.bbc.co.uk/hindi/">BBC Hindi</a><span></span></li>
					<li class="lang-multi"><a href="#">Multiple stories</a></li>
				</ul>
			</div>
		</div>
		<div id="overlay"></div>
		
		<script type="text/javascript" src="http://tile.cloudmade.com/wml/latest/web-maps-lite.js"></script>
		<script type="text/javascript">
		
			// Global variables
			var cloudmade = new CM.Tiles.CloudMade.Web({key: '19d57a2cbf9e53fc8185f2a86b8abf42', styleId: 6726});
			var map = new CM.Map('map', cloudmade);
			var mapPlaces = {};
			var stats = {};
			var timestamp;
			var pb = $("#progressbar");
			var TRANSLATE_URL = "http://translate.google.com/translate?hl=en&sl=auto&u=";			
			
			
			// On load event handler
			$(function() {
                
                if($.browser.msie){
                    alert("This page works best in Firefox 3+, Chrome or Safari. Newer versions of Internet Explorer (IE7+) might work.");
                }
            
				// Reset progressbar
				pb.progressbar({
					value: 100
				});
				
				// Initialise auto update
				if (window.location.search.substring(1) == "auto=true") {
					var countdownInterval = 5*60*1000 / 100;
					window.setInterval(
						function() {
							var value = pb.progressbar('option', 'value');
							value--;
							if (value == 0) {
								getItems();
								resetCountdown();
							} else {
								pb.progressbar('option', 'value', value);
							}
						}, 
						countdownInterval
					)
				}
			});


			// Map load event handler
			CM.Event.addListener(map, 'load', function() {
			
				getItems();

				// Connect refresh button
				$("#refresh").click(
					function() {
						getItems();
						resetCountdown();
					}
				);
				
			});

			
			map.setCenter(new CM.LatLng(25, 10), 2);
			map.addControl(new CM.SmallMapControl());
			
			var icon_pt = createIcon("../images/marker_pt.png");
			var icon_vi = createIcon("../images/marker_vi.png");
			var icon_ru = createIcon("../images/marker_ru.png");
			var icon_es = createIcon("../images/marker_es.png");	
			var icon_fa = createIcon("../images/marker_fa.png");					
			var icon_ar = createIcon("../images/marker_ar.png");
			var icon_hi = createIcon("../images/marker_hi.png");
			var icon_tr = createIcon("../images/marker_tr.png");
			var icon_multi =  new CM.Icon();
			icon_multi.image = "../images/marker_multi_16x16.png";	
			icon_multi.iconSize = new CM.Size(16, 16);
			icon_multi.iconAnchor = new CM.Point(8, 8);
			
			// Create map marker
			function createIcon(path) {
				var icon = new CM.Icon();
				icon.image = path;	
				icon.iconSize = new CM.Size(13, 13);
				icon.iconAnchor = new CM.Point(6, 6);
				
				return icon;
			}
			
			// Reset progressbar
			function resetCountdown() {
				pb.progressbar('option', 'value', 100);
			}
			
			// Get new items
			function getItems() {
				// Get pages
				$.getJSON(
					"http://newsviz.appspot.com/pages/?render=json&callback=?",
					function(data){
						initPages(data.results.pages);
						$("#overlay").remove();
						
						// Update stats
						for (var o in stats) {
							var node = $("#stats .lang-" + o + " span")[0];
							
							$(node).html(" (" + stats[o] + " stories)");
						}
					}
				);
				
				// Get people
				$.getJSON(
					"http://newsviz.appspot.com/person/?render=json&callback=?",
					function(data){
						initPersons(data.results.persons);
					}
				);
			}
			
			// Init pages
			function initPages(pages) {
				var status = $("#status").html("<h3>" + pages.length + " stories in the last 12 hours</h3>");
				var list = $("#pages ol")[0];
				
				if (timestamp) {
					// Clear new class
					$("#pages ol li.new").each(function(i) {
						$(this).removeClass("new");
					});
					
					// Get new pages
					newPages = jQuery.grep(pages, function(page, i){
						page.date = page.date.split(".")[0];
						var date = $.timeago.parse(page.date);
						return (date > timestamp);
					});
					
					pages = newPages;
				}
				
				var delay = 0;
				if (pages.length > 0) {
					$.each(pages, function(i, page){
						page.date = page.date.split(".")[0];
						if (page.lang != "ur") {
							var node = addPage(page);
							$(list).prepend(node);
							
							if ($.timeago.parse(page.date) > timestamp) {
								// Set a class on new items
								$(node).addClass("new");
							}
							
							if (timestamp) {
								delay += 100;
								setTimeout(function(){
									$(node).fadeIn(1000);
								}, delay);
							} else {
								$(node).fadeIn(600);
							}
						}
					});
					
					// Save most current timestamp (used in refreshPages)
					timestamp = $.timeago.parse(pages[pages.length - 1].date);
					
					// Get old pages
					//oldPages = jQuery.grep(pages, function(page, i){
					//	var date = $.timeago.parse(page.date);
					//	return (date > timestamp);
					//});
					
					initPlaces(mapPlaces);
				}
			}

			// Init places
			function initPlaces(places) {
				$.each(places, function(i, place){
					addPlace(place, place.lang);
				});
			}

			// Init persons
			function initPersons(persons) {
				var list = $("#people ol")[0];
				$(list).empty();
				if (persons.length > 0) {
					$.each(persons, function(i, person){
						var node = addPerson(person);
						$(list).append(node);
					});
				}
			}
			
			
			function addPerson(person) {
				var node = $("<li></li>");
				var image = $("<img src=\"http://api.freebase.com/api/trans/image_thumb/guid/" + person.guid + "?maxheight=120&amp;maxwidth=100&amp;mode=fillcrop\" />").appendTo(node);
				var title = $("<h3>" + person.label + "</h3>").appendTo(node);
				var pages = $("<ul></ul>").appendTo(node);
				
				for (var i = 0; i < 1; i++) {
					var page = person.results.pages[i];
					
					if (page) {
						$("<li><a href=\"" + page.url + "\">" + page.title.translation + "</a></li>").appendTo(pages);
					}
				}
				
				return node;
			}
			
			function addPage(page) {
				var node = $("<li class=\"lang-" + page.lang + "\"></li>");
				var title = $("<h2><a target=\"translate\" href=\"" + TRANSLATE_URL + page.url + "\">" + page.title.translation + "</a></h2>").appendTo(node);
				var summary = $("<p>" + page.summary.translation + "</p>").appendTo(node);
				var meta = $("<p class=\"meta\"></p>").appendTo(node);
				
				var timeago = jQuery.timeago(page.date);
				
				var site = $("<p class=\"site\">" + timeago + " in <a href=\"" + page.site + "\">" + page.site + "</a></p>").appendTo(node);
				
				if (page.places && page.places.length > 0) {
					var places = $("<span class=\"places\"></span>");
					
					$.each(page.places, function(i, place){
						if (place.label) {
							if (place.confidence > 0.27) {
                                var id = place.id.slice(place.id.lastIndexOf("/"));
								$(places).append("<a href=\"http://newsviz.appspot.com/resource" + id + "\">" + place.label.en + "</a> ");

								if (mapPlaces[place.label.en]) {
									mapPlaces[place.label.en].pages.push({url: page.url, lang: page.lang, title: page.title.translation, summary: page.summary.translation});
									mapPlaces[place.label.en].lang = "multi";
								} else {
									mapPlaces[place.label.en] = place;
									mapPlaces[place.label.en]["pages"] = [{url: page.url, lang: page.lang, title: page.title.translation, summary: page.summary.translation}];
									mapPlaces[place.label.en]["lang"] = page.lang;
								}
							}
						}
					});
					if (places[0].firstChild) {
						$(places).prepend("Places: ");
						$(places).appendTo(meta);
					}
					
				}
				
				if (page.people && page.people.length > 0) {
					var people = $("<span class=\"people\"></span>");
					
					$.each(page.people, function(i, person){
						if (person.label) {
                            var id = person.id.slice(person.id.lastIndexOf("/"));
							$(people).append("<a href=\"http://newsviz.appspot.com/resource" + id + "\">" + person.label.en + "</a> ");
						}
					});
					if (people[0].firstChild) {
						$(people).prepend("People: ");
						$(people).appendTo(meta);
					}
				}
				
				if (page.organizations && page.organizations.length > 0) {
					var organizations = $("<span class=\"organizations\"></span>");
					
					$.each(page.organizations, function(i, organization){
						if (organization.label) {
                            var id = organization.id.slice(organization.id.lastIndexOf("/"));
							$(organizations).append("<a href=\"http://newsviz.appspot.com/resource" + id + "\">" + organization.label.en + "</a> ");
						}
					});
					if (organizations[0].firstChild) {
						$(organizations).prepend("Organizations: ");
						$(organizations).appendTo(meta);
					}
				}
				
				if (page.events && page.events.length > 0) {
					var events = $("<span class=\"events\"></span>");
					
					$.each(page.events, function(i, event){
						if (event.label) {
                            var id = event.id.slice(event.id.lastIndexOf("/"));
							$(events).append("<a href=\"http://newsviz.appspot.com/resource" + id + "\">" + event.label.en + "</a> ");
						}
					});
					if (events[0].firstChild) {
						$(events).prepend("Events: ");
						$(events).appendTo(meta);
					}
				}
				
				// Update stats
				if (stats[page.lang]) {
					stats[page.lang] = stats[page.lang] + 1;
				} else {
					stats[page.lang] = 1;
				}
				
				return node;
			}
			
			function addPlace(place, lang) {
				if (place.geolocation) {
					var icon;
					switch(lang) {
						case "multi":
							icon = icon_multi;
							break;
						case "pt-BR":
							icon = icon_pt;
							break;
						case "vi":
							icon = icon_vi;
							break;
						case "ru":
							icon = icon_ru;
							break;
						case "es":
							icon = icon_es;
							break;
						case "fa":
							icon = icon_fa;
							break;
						case "ar":
							icon = icon_ar;
							break;
						case "hi":
							icon = icon_hi;
							break;
						case "tr":
							icon = icon_tr;
							break;
						default:
							icon = icon_fa;
					}
					var position = new CM.LatLng(place.geolocation.latitude, place.geolocation.longitude);
					var marker = new CM.Marker(position, {title: place.label.en, icon: icon});
					var stories = "";
					
					for (var i = 0; i < place.pages.length; i++) {
						page = place.pages[i];
						stories = stories + "<li class=\"lang-" + page.lang +"\"><h3><a target=\"translate\" href=\"" + TRANSLATE_URL + page.url + "\">" + page.title + "</a></h3><p>" + page.summary + "</p></li>";
					}
					
					marker.bindInfoWindow(
						"<h2>" + place.label.en + "</h2>" + "<ul>" + stories + "</ul>",
						{maxWidth:400}
					);

					map.addOverlay(marker);
				}
			}
			
		</script>
		<script type="text/javascript">
			var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
			document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		</script>
		<script type="text/javascript">
			try {
				var pageTracker = _gat._getTracker("UA-10456994-1");
				pageTracker._trackPageview();
			} catch(err) {}
		</script>
	</body>
</html>